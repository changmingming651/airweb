<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¤å…§è¨­è¨ˆé è¦½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .app-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .btn {
            transition: all 0.3s ease;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .style-card {
            border: 3px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .style-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.2);
            transform: translateY(-4px);
        }
        .style-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-container {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .progress-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background: #f9fafb;
        }
        .progress-step.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px solid #667eea;
        }
        .progress-step.completed {
            background: #d1fae5;
            border: 2px solid #10b981;
        }
        .tab-button {
            padding: 1rem 2rem;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .tab-button:hover {
            color: #667eea;
        }
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .render-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .render-item {
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .render-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }
        .render-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .render-item:hover .render-overlay {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600 mb-3">
                å®¤å…§è¨­è¨ˆé è¦½
            </h1>
            <p class="text-gray-600 text-lg">è¼¸å…¥å¹³é¢åœ–ã€åªæ•¸ã€é ç®—å’Œé¢¨æ ¼ï¼Œè®“æˆ‘ç‚ºæ‚¨è¨­è¨ˆ</p>
        </header>

        <!-- è¼¸å…¥è¡¨å–® -->
        <div id="input-section" class="mb-8">
            
            <!-- å¹³é¢åœ–ä¸Šå‚³å€ -->
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ ä¸Šå‚³å¹³é¢åœ–</h3>
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-8 border-2 border-dashed border-purple-300">
                    
                    <!-- ä¸Šå‚³å€åŸŸ -->
                    <div id="upload-area" class="text-center cursor-pointer transition-all hover:bg-purple-100 p-8 rounded-lg">
                        <input type="file" id="floorplan-upload" accept="image/*" class="hidden">
                        <div class="text-6xl mb-4">ğŸ </div>
                        <h4 class="text-xl font-semibold text-gray-700 mb-2">é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³å¹³é¢åœ–</h4>
                        <p class="text-gray-600 mb-4">æ”¯æ´ JPG, PNG æ ¼å¼</p>
                        <button type="button" onclick="document.getElementById('floorplan-upload').click()" 
                                class="btn bg-purple-600 text-white hover:bg-purple-700">
                            é¸æ“‡æª”æ¡ˆ
                        </button>
                    </div>

                    <!-- é è¦½å€åŸŸ -->
                    <div id="upload-preview" class="hidden mt-6">
                        <div class="bg-white rounded-lg p-4 shadow-md">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="font-semibold text-gray-700">âœ… å·²ä¸Šå‚³çš„å¹³é¢åœ–</h5>
                                <button id="clear-upload" class="text-red-600 hover:text-red-800 font-semibold text-sm">
                                    ğŸ—‘ï¸ æ¸…é™¤
                                </button>
                            </div>
                            <img id="floorplan-preview-img" src="" alt="å¹³é¢åœ–é è¦½" class="w-full max-h-80 object-contain rounded-lg border-2 border-gray-200">
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                
                <!-- åªæ•¸è¼¸å…¥ -->
                <div class="bg-gray-50 p-6 rounded-xl">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">
                        ğŸ  å®¤å…§åªæ•¸
                    </label>
                    <input 
                        type="number" 
                        id="square-meters" 
                        class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl focus:border-purple-500 focus:outline-none"
                        placeholder="ä¾‹å¦‚: 30"
                        value="30"
                        min="10"
                        max="200"
                    />
                    <p class="text-sm text-gray-500 mt-2">
                        ç´„ <span id="sqm-display">99</span> å¹³æ–¹å…¬å°º
                    </p>
                </div>

                <!-- é ç®—è¼¸å…¥ -->
                <div class="bg-gray-50 p-6 rounded-xl">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">
                        ğŸ’° è£æ½¢é ç®— (NT$)
                    </label>
                    <input 
                        type="number" 
                        id="budget" 
                        class="w-full p-4 border-2 border-gray-300 rounded-lg text-xl focus:border-purple-500 focus:outline-none"
                        placeholder="ä¾‹å¦‚: 800000"
                        value="800000"
                        min="100000"
                        step="50000"
                    />
                    <p class="text-sm text-gray-500 mt-2">
                        ç´„æ¯åª <span id="budget-per-ping">27k</span>
                    </p>
                </div>


            </div>

            <!-- é¢¨æ ¼é¸æ“‡ -->
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ¨ é¸æ“‡è¨­è¨ˆé¢¨æ ¼</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4" id="style-grid">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ç”ŸæˆæŒ‰éˆ• -->
            <div class="text-center">
                <button 
                    id="generate-btn" 
                    class="btn btn-primary text-xl px-12 py-4 shadow-lg"
                >
                    ğŸš€ é–‹å§‹ç”Ÿæˆè¨­è¨ˆæ–¹æ¡ˆ
                </button>
            </div>
        </div>

        <!-- é€²åº¦é¡¯ç¤º -->
        <div id="progress-section" class="mb-8 hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">â³ ç”Ÿæˆé€²åº¦</h3>
            
            <div class="progress-step" id="step-1">
                <div class="flex items-center flex-1">
                    <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mr-4 font-bold">1</div>
                    <div>
                        <div class="font-semibold">åˆ†æç©ºé–“éœ€æ±‚</div>
                        <div class="text-sm text-gray-600">æ ¹æ“šåªæ•¸å’Œé ç®—è¦åŠƒç©ºé–“é…ç½®</div>
                    </div>
                </div>
                <div class="loader hidden" id="loader-1"></div>
            </div>

            <div class="progress-step" id="step-2">
                <div class="flex items-center flex-1">
                    <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mr-4 font-bold">2</div>
                    <div>
                        <div class="font-semibold">ç”Ÿæˆå¹³é¢é…ç½®åœ–</div>
                        <div class="text-sm text-gray-600">å‰µå»ºå¸¶å‚¢ä¿±çš„å®¤å…§å¹³é¢åœ–</div>
                    </div>
                </div>
                <div class="loader hidden" id="loader-2"></div>
            </div>

            <div class="progress-step" id="step-3">
                <div class="flex items-center flex-1">
                    <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mr-4 font-bold">3</div>
                    <div>
                        <div class="font-semibold">ç”Ÿæˆç©ºé–“æ¸²æŸ“åœ–</div>
                        <div class="text-sm text-gray-600" id="render-progress">æº–å‚™ç”Ÿæˆå„ç©ºé–“çš„å¯«å¯¦æ•ˆæœåœ–</div>
                    </div>
                </div>
                <div class="loader hidden" id="loader-3"></div>
            </div>
        </div>

        <!-- çµæœé¡¯ç¤º -->
        <div id="result-section" class="hidden">
            <h3 class="text-3xl font-bold text-gray-800 mb-6">âœ¨ è¨­è¨ˆæˆæœ</h3>
            
            <!-- æ¨™ç±¤åˆ‡æ› -->
            <div class="flex border-b-2 border-gray-200 mb-6">
                <button class="tab-button active" data-tab="floorplan">
                    ğŸ“ å¹³é¢é…ç½®åœ–
                </button>
                <button class="tab-button" data-tab="renders">
                    ğŸ  ç©ºé–“æ¸²æŸ“åœ–
                </button>
                <button class="tab-button" data-tab="details">
                    ğŸ“ è¨­è¨ˆèªªæ˜
                </button>
            </div>

            <!-- å¹³é¢é…ç½®åœ– -->
            <div id="tab-floorplan" class="tab-content">
                <div class="image-container bg-gray-100 flex items-center justify-center" style="min-height: 500px;">
                    <img id="floorplan-image" src="" alt="å¹³é¢é…ç½®åœ–" class="max-w-full max-h-[700px] object-contain" style="display:none;">
                    <span id="floorplan-placeholder" class="text-gray-400">å¹³é¢åœ–å°‡é¡¯ç¤ºåœ¨é€™è£¡</span>
                </div>
            </div>

            <!-- ç©ºé–“æ¸²æŸ“åœ– -->
            <div id="tab-renders" class="tab-content hidden">
                <div id="renders-container" class="render-grid">
                    <!-- å‹•æ…‹ç”Ÿæˆæ¸²æŸ“åœ– -->
                </div>
            </div>

            <!-- è¨­è¨ˆèªªæ˜ -->
            <div id="tab-details" class="tab-content hidden">
                <div class="bg-gray-50 rounded-xl p-8">
                    <h4 class="text-2xl font-bold mb-4">è¨­è¨ˆæ¦‚å¿µ</h4>
                    <p id="design-concept" class="text-gray-700 leading-relaxed mb-6"></p>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-bold text-lg mb-3">ğŸ¨ è‰²å½©é…ç½®</h5>
                            <div id="color-scheme" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div>
                            <h5 class="font-bold text-lg mb-3">ğŸªµ å»ºæå»ºè­°</h5>
                            <ul id="materials-list" class="list-disc list-inside text-gray-600"></ul>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h5 class="font-bold text-lg mb-3">ğŸ  ç©ºé–“é…ç½®</h5>
                        <div id="rooms-list" class="grid md:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="mt-8 flex gap-4 justify-center">
                <button id="download-all-btn" class="btn bg-green-600 text-white hover:bg-green-700">
                    ğŸ’¾ ä¸‹è¼‰å…¨éƒ¨åœ–ç‰‡
                </button>
                <button id="regenerate-btn" class="btn bg-purple-600 text-white hover:bg-purple-700">
                    ğŸ”„ é‡æ–°ç”Ÿæˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================
        // è¨­è¨ˆå¸«é¢¨æ ¼è³‡æ–™åº«
        // ====================================
        const DESIGNER_STYLES = {
            'modern-minimalist': {
                id: 'modern-minimalist',
                label: 'ç¾ä»£ç°¡ç´„',
                emoji: 'âšª',
                description: 'ç°¡æ½”ç·šæ¢ã€ä¸­æ€§è‰²èª¿',
                designer: {
                    name: 'Vincent Van Duysen',
                    colorPalette: ['ç±³ç™½è‰²', 'æ·ºç°è‰²', 'æ·ºæœ¨è‰²', 'çŸ³ç°è‰²'],
                    materials: ['å¤©ç„¶æ©¡æœ¨', 'çŸ³ç°å²©', 'äºéº»å¸ƒ', 'æ‹‰çµ²é‹¼'],
                    keywords: [
                        'minimalist purity',
                        'natural materials',
                        'subtle textures',
                        'timeless elegance',
                        'monochromatic palette',
                        'serene calm atmosphere'
                    ],
                    promptTemplate: `Interior design by Vincent Van Duysen style:
- Pure minimalist aesthetic with timeless appeal
- Natural materials: pale oak, limestone, raw linen
- Monochromatic neutral color scheme
- Clean architectural lines with subtle textural variations
- Abundance of natural light creating serene atmosphere
- High-end architectural photography, soft natural light`
                }
            },
            'scandinavian': {
                id: 'scandinavian',
                label: 'åŒ—æ­é¢¨æ ¼',
                emoji: 'ğŸŒ²',
                description: 'æº«æš–æœ¨è³ªã€è‡ªç„¶æ¡å…‰',
                designer: {
                    name: 'Studio McGee',
                    colorPalette: ['æº«æš–ç™½', 'ç°è¤è‰²', 'æ·ºè—è‰²', 'å¤©ç„¶æœ¨è‰²'],
                    materials: ['æ·ºæ©¡æœ¨', 'äºéº»å¸ƒ', 'è—¤ç·¨', 'å¤©ç„¶çº–ç¶­'],
                    keywords: [
                        'Scandinavian modern',
                        'warm neutral palette',
                        'light wood tones',
                        'cozy textiles',
                        'natural light',
                        'comfortable elegance'
                    ],
                    promptTemplate: `Interior design by Studio McGee - Scandinavian style:
- Refined casual elegance with Nordic influence
- Warm neutral colors with light wood tones
- Layered natural textiles and cozy elements
- Abundant natural light in airy spaces
- Mix of modern and organic elements
- Plants and natural accessories
- Professional lifestyle photography, bright soft lighting`
                }
            },
            'luxury-modern': {
                id: 'luxury-modern',
                label: 'ç¾ä»£å¥¢è¯',
                emoji: 'ğŸ’',
                description: 'ç²¾ç·»æè³ªã€å„ªé›…è‰²å½©',
                designer: {
                    name: 'Kelly Hoppen',
                    colorPalette: ['é§è‰²', 'å¥¶æ²¹è‰²', 'æŸ”ç°è‰²', 'é‡‘è‰²é»ç¶´'],
                    materials: ['å¤©éµçµ¨', 'çµ²ç¶¢', 'æ‹‹å…‰å¤§ç†çŸ³', 'é»ƒéŠ…', 'çƒ¤æ¼†'],
                    keywords: [
                        'luxurious sophistication',
                        'symmetrical layout',
                        'neutral tones',
                        'opulent textures',
                        'layered lighting',
                        'East-West fusion'
                    ],
                    promptTemplate: `Interior design by Kelly Hoppen luxury style:
- Sophisticated neutral palette with taupe, cream, soft grey
- Luxurious textures: velvet, silk, polished marble
- Perfect symmetry and balanced composition
- Subtle East-meets-West fusion elements
- Layered ambient lighting with warm elegant glow
- Clean lines with opulent details
- High-end interior photography, dramatic elegant lighting`
                }
            },
            'industrial': {
                id: 'industrial',
                label: 'å·¥æ¥­é¢¨æ ¼',
                emoji: 'ğŸ­',
                description: 'è£¸éœ²æè³ªã€å€‹æ€§ç©ºé–“',
                designer: {
                    name: 'Nate Berkus',
                    colorPalette: ['æº«æš–ä¸­æ€§è‰²', 'æ·±è—è‰²', 'é™¶åœŸè‰²', 'æ©„æ¬–ç¶ '],
                    materials: ['å›æ”¶æœ¨æ', 'äºéº»å¸ƒ', 'å¾©å¤é»ƒéŠ…', 'çš®é©'],
                    keywords: [
                        'industrial chic',
                        'exposed materials',
                        'vintage elements',
                        'warm inviting atmosphere',
                        'collected pieces',
                        'comfortable luxury'
                    ],
                    promptTemplate: `Interior design by Nate Berkus - Industrial style:
- Warm industrial aesthetic with collected touches
- Mix of vintage and contemporary pieces
- Exposed brick, metal, reclaimed wood
- Layered textiles: linen, leather, woven fabrics
- Rich warm color palette with character
- Personal artifacts and meaningful objects
- Editorial interior photography, natural warm lighting`
                }
            },
            'japanese-zen': {
                id: 'japanese-zen',
                label: 'æ—¥å¼ç¦ªé¢¨',
                emoji: 'ğŸ‹',
                description: 'è‡ªç„¶ç´ æã€å¯§éœæ°›åœ',
                designer: {
                    name: 'Axel Vervoordt',
                    colorPalette: ['åŸå§‹ç°', 'å¤©ç„¶ç±³', 'é¢¨åŒ–ç™½', 'å¤§åœ°è‰²èª¿'],
                    materials: ['è€åŒ–æœ¨æ', 'æ¸…æ°´æ··å‡åœŸ', 'å¤©ç„¶çŸ³æ', 'å¤è‘£ç¹”å“'],
                    keywords: [
                        'wabi-sabi philosophy',
                        'aged patina',
                        'organic materials',
                        'spiritual minimalism',
                        'raw textures',
                        'contemplative atmosphere'
                    ],
                    promptTemplate: `Interior design by Axel Vervoordt - Japanese Zen:
- Wabi-sabi aesthetic celebrating imperfection
- Aged weathered materials with beautiful patina
- Muted earthy color palette
- Mix of ancient and contemporary elements
- Raw organic textures and natural materials
- Spiritual contemplative atmosphere
- Fine art photography, soft diffused natural lighting`
                }
            }
        };

        // ====================================
        // ç‹€æ…‹ç®¡ç†
        // ====================================
        const state = {
            squareMeters: 30,
            budget: 800000,
            selectedStyle: 'modern-minimalist',
            uploadedFloorplan: null,  // ä¸Šå‚³çš„å¹³é¢åœ– base64
            uploadedFileName: '',
            isGenerating: false,
            currentStep: 0,
            layoutData: null,
            floorplanImage: null,
            renders: []
        };

        // API Keyï¼ˆç›´æ¥è¨­å®šåœ¨ç¨‹å¼ç¢¼ä¸­ï¼‰
        const API_KEY = "AIzaSyBnficu4WvKraFrO0XJIOD95ZIYbM9aAgI";

        // ====================================
        // DOM å…ƒç´ 
        // ====================================
        const squareMetersInput = document.getElementById('square-meters');
        const budgetInput = document.getElementById('budget');
        const styleGrid = document.getElementById('style-grid');
        const generateBtn = document.getElementById('generate-btn');
        const floorplanUpload = document.getElementById('floorplan-upload');
        const uploadArea = document.getElementById('upload-area');
        const uploadPreview = document.getElementById('upload-preview');
        const floorplanPreviewImg = document.getElementById('floorplan-preview-img');
        const clearUploadBtn = document.getElementById('clear-upload');
        const inputSection = document.getElementById('input-section');
        const progressSection = document.getElementById('progress-section');
        const resultSection = document.getElementById('result-section');

        // ====================================
        // åˆå§‹åŒ–
        // ====================================
        function init() {
            renderStyleGrid();
            setupEventListeners();
            updateCalculations();
        }

        function renderStyleGrid() {
            styleGrid.innerHTML = '';
            Object.values(DESIGNER_STYLES).forEach(style => {
                const card = document.createElement('div');
                card.className = `style-card ${state.selectedStyle === style.id ? 'selected' : ''}`;
                card.innerHTML = `
                    <div class="text-4xl mb-2 text-center">${style.emoji}</div>
                    <h4 class="font-bold text-center mb-1">${style.label}</h4>
                    <p class="text-xs text-gray-600 text-center">${style.description}</p>
                `;
                card.onclick = () => selectStyle(style.id);
                styleGrid.appendChild(card);
            });
        }

        function selectStyle(styleId) {
            state.selectedStyle = styleId;
            renderStyleGrid();
        }

        function setupEventListeners() {
            squareMetersInput.addEventListener('input', updateCalculations);
            budgetInput.addEventListener('input', updateCalculations);
            generateBtn.addEventListener('click', startGeneration);

            // å¹³é¢åœ–ä¸Šå‚³
            floorplanUpload.addEventListener('change', handleFloorplanUpload);
            clearUploadBtn.addEventListener('click', handleClearUpload);
            
            // æ‹–æ‹½ä¸Šå‚³
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('bg-purple-100');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('bg-purple-100');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('bg-purple-100');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processFloorplanFile(file);
                }
            });

            // æ¨™ç±¤åˆ‡æ›
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    btn.classList.add('active');
                    document.getElementById(`tab-${tab}`).classList.remove('hidden');
                });
            });

            document.getElementById('regenerate-btn').addEventListener('click', () => {
                resultSection.classList.add('hidden');
                inputSection.classList.remove('hidden');
                state.currentStep = 0;
            });
        }

        function handleFloorplanUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFloorplanFile(file);
            }
        }

        function processFloorplanFile(file) {
            state.uploadedFileName = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                state.uploadedFloorplan = base64;
                
                // é¡¯ç¤ºé è¦½
                uploadArea.classList.add('hidden');
                uploadPreview.classList.remove('hidden');
                floorplanPreviewImg.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleClearUpload() {
            state.uploadedFloorplan = null;
            state.uploadedFileName = '';
            floorplanUpload.value = '';
            uploadArea.classList.remove('hidden');
            uploadPreview.classList.add('hidden');
        }

        function updateCalculations() {
            state.squareMeters = parseFloat(squareMetersInput.value) || 0;
            state.budget = parseFloat(budgetInput.value) || 0;

            const sqm = (state.squareMeters * 3.306).toFixed(0);
            const budgetPerPing = state.squareMeters > 0 ? Math.round(state.budget / state.squareMeters / 1000) : 0;

            document.getElementById('sqm-display').textContent = sqm;
            document.getElementById('budget-per-ping').textContent = `${budgetPerPing}k`;
        }

        // ====================================
        // Gemini API èª¿ç”¨
        // ====================================
        async function callGeminiAPI(prompt, images = []) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`;

            const parts = [];
            
            if (images.length > 0) {
                images.forEach(base64 => {
                    parts.push({
                        inline_data: {
                            mime_type: "image/png",
                            data: base64
                        }
                    });
                });
            }
            
            parts.push({ text: prompt });

            const requestBody = {
                contents: [{
                    parts: parts
                }],
                generationConfig: {
                    temperature: 0.9,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API èª¿ç”¨å¤±æ•—');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function generateImageWithGemini(prompt) {
            console.log("Generating image with Gemini...");
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE'],
                    temperature: 0.8,
                    maxOutputTokens: 2048
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ]
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                console.error("API Error:", errorBody);
                throw new Error(`åœ–åƒç”Ÿæˆå¤±æ•—: ${response.status}`);
            }

            const result = await response.json();
            const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);

            if (imagePart) {
                return imagePart.inlineData.data;
            } else {
                throw new Error("API æœªè¿”å›æœ‰æ•ˆçš„åœ–ç‰‡è³‡æ–™");
            }
        }

        // ====================================
        // ç”Ÿæˆæµç¨‹
        // ====================================
        async function startGeneration() {
            if (state.isGenerating) return;
            
            // æª¢æŸ¥æ˜¯å¦ä¸Šå‚³å¹³é¢åœ–
            if (!state.uploadedFloorplan) {
                alert('è«‹å…ˆä¸Šå‚³å¹³é¢åœ–ï¼');
                return;
            }

            state.isGenerating = true;
            generateBtn.classList.add('btn-disabled');
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';

            inputSection.classList.add('hidden');
            progressSection.classList.remove('hidden');

            try {
                // Step 1: åˆ†æç©ºé–“éœ€æ±‚
                await updateProgress(1, 'active');
                await step1_analyzeSpace();
                await updateProgress(1, 'completed');

                // Step 2: ç”Ÿæˆå¹³é¢åœ–
                await updateProgress(2, 'active');
                await step2_generateFloorplan();
                await updateProgress(2, 'completed');

                // Step 3: ç”Ÿæˆæ¸²æŸ“åœ–
                await updateProgress(3, 'active');
                await step3_generateRenders();
                await updateProgress(3, 'completed');

                // é¡¯ç¤ºçµæœ
                progressSection.classList.add('hidden');
                resultSection.classList.remove('hidden');

            } catch (error) {
                console.error('ç”Ÿæˆå¤±æ•—:', error);
                alert(`ç”Ÿæˆå¤±æ•—: ${error.message}`);
                progressSection.classList.add('hidden');
                inputSection.classList.remove('hidden');
            } finally {
                state.isGenerating = false;
                generateBtn.classList.remove('btn-disabled');
                generateBtn.textContent = 'ğŸš€ é–‹å§‹ç”Ÿæˆè¨­è¨ˆæ–¹æ¡ˆ';
            }
        }

        async function updateProgress(step, status) {
            const stepEl = document.getElementById(`step-${step}`);
            const loaderEl = document.getElementById(`loader-${step}`);

            if (status === 'active') {
                stepEl.classList.add('active');
                loaderEl.classList.remove('hidden');
            } else if (status === 'completed') {
                stepEl.classList.remove('active');
                stepEl.classList.add('completed');
                loaderEl.classList.add('hidden');
                const numberDiv = stepEl.querySelector('.w-10');
                numberDiv.textContent = 'âœ“';
                numberDiv.classList.add('bg-green-500', 'text-white');
            }
        }

        async function step1_analyzeSpace() {
            const designer = DESIGNER_STYLES[state.selectedStyle].designer;
            
            const prompt = `è«‹åˆ†æé€™å¼µå®¤å…§å¹³é¢åœ–ï¼Œä¸¦ç‚ºä»¥ä¸‹æ¢ä»¶è¦åŠƒç©ºé–“é…ç½®ï¼š

åŸºæœ¬è³‡è¨Šï¼š
- å®¤å…§åªæ•¸ï¼š${state.squareMeters} åªï¼ˆç´„ ${(state.squareMeters * 3.306).toFixed(1)} å¹³æ–¹å…¬å°ºï¼‰
- è£æ½¢é ç®—ï¼šNT$ ${state.budget.toLocaleString()}
- è¨­è¨ˆé¢¨æ ¼ï¼š${DESIGNER_STYLES[state.selectedStyle].label}
- è¨­è¨ˆå¸«åƒè€ƒï¼š${designer.name}

è«‹ä»”ç´°åˆ†æå¹³é¢åœ–ä¸­çš„ï¼š
1. æˆ¿é–“æ ¼å±€å’Œæ•¸é‡
2. é–€çª—ä½ç½®
3. ç©ºé–“å°ºå¯¸æ¯”ä¾‹
4. å‹•ç·šé…ç½®

ç„¶å¾Œæä¾›å®Œæ•´çš„å®¤å…§è¨­è¨ˆè¦åŠƒï¼Œä»¥ JSON æ ¼å¼å›å‚³ï¼š
{
  "layout": {
    "total_area": "${state.squareMeters}åª",
    "rooms": [
      {
        "name": "å®¢å»³",
        "area": "10åª",
        "furniture": ["Lå‹æ²™ç™¼", "é›»è¦–æ«ƒ", "èŒ¶å‡ ", "é‚Šå‡ "],
        "features": ["è½åœ°çª—", "ä¸»è¦æ¡å…‰é¢"],
        "design_notes": "é–‹æ”¾å¼è¨­è¨ˆï¼Œé€£æ¥é¤å»³ï¼Œæ¡ç”¨${designer.name}çš„${DESIGNER_STYLES[state.selectedStyle].label}é¢¨æ ¼"
      }
    ]
  },
  "design_concept": "æ ¹æ“šå¹³é¢åœ–åˆ†æï¼Œæä¾›æ•´é«”è¨­è¨ˆæ¦‚å¿µçš„è©³ç´°èªªæ˜ï¼ˆè‡³å°‘150å­—ï¼‰",
  "material_suggestions": ["å»ºæ1", "å»ºæ2", "å»ºæ3", "å»ºæ4"],
  "color_scheme": ${JSON.stringify(designer.colorPalette)}
}

è«‹ç¢ºä¿:
1. æ ¹æ“šå¯¦éš›å¹³é¢åœ–çš„æ ¼å±€é€²è¡Œåˆ†æ
2. è€ƒæ…®åªæ•¸å’Œé ç®—é¸æ“‡åˆé©çš„è¨­è¨ˆæ–¹æ¡ˆ
3. å®Œå…¨ç¬¦åˆ${DESIGNER_STYLES[state.selectedStyle].label}é¢¨æ ¼ç‰¹é»
4. æä¾›è©³ç´°ä¸”å°ˆæ¥­çš„è¨­è¨ˆèªªæ˜`;

            // ä½¿ç”¨ä¸Šå‚³çš„å¹³é¢åœ–èª¿ç”¨ API
            const response = await callGeminiAPI(prompt, [state.uploadedFloorplan]);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                state.layoutData = JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('ç„¡æ³•è§£æç©ºé–“é…ç½®è³‡æ–™');
            }
        }

        async function step2_generateFloorplan() {
            const designer = DESIGNER_STYLES[state.selectedStyle].designer;
            
            const roomsDesc = state.layoutData.layout.rooms.map(room => 
                `${room.name} (${room.area}): ${room.furniture.join(', ')}`
            ).join('\n');

            const floorplanPrompt = `Create a professional architectural floor plan illustration:

Style: ${DESIGNER_STYLES[state.selectedStyle].label} - ${designer.name} inspired
Total Area: ${(state.squareMeters * 3.306).toFixed(0)} square meters

Rooms layout:
${roomsDesc}

Requirements:
- Top-down architectural view
- Clear room boundaries with dimensions
- Furniture placement (top view icons)
- Door swings and window positions
- Room labels in clean font
- Scale indicator
- North arrow
- Color-coded zones (living area: warm tones, bedrooms: cool tones, wet areas: blue)
- Professional architectural drawing style
- White background with thin black lines
- Subtle color fills for different functional zones
- Modern, clean presentation

Technical style: Clean architectural illustration, professional CAD-like appearance, clear annotations`;

            try {
                const base64Image = await generateImageWithGemini(floorplanPrompt);
                state.floorplanImage = `data:image/png;base64,${base64Image}`;
                
                const img = document.getElementById('floorplan-image');
                const placeholder = document.getElementById('floorplan-placeholder');
                img.src = state.floorplanImage;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            } catch (error) {
                console.error('å¹³é¢åœ–ç”Ÿæˆå¤±æ•—ï¼Œä½¿ç”¨æ–‡å­—æ›¿ä»£:', error);
                document.getElementById('floorplan-placeholder').textContent = 'å¹³é¢åœ–ç”Ÿæˆå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ç©ºé–“é…ç½®èªªæ˜';
            }
        }

        async function step3_generateRenders() {
            const designer = DESIGNER_STYLES[state.selectedStyle].designer;
            const rooms = state.layoutData.layout.rooms;
            const renderProgressEl = document.getElementById('render-progress');
            
            state.renders = [];
            let completed = 0;
            const total = rooms.length * 1.5; // ä¼°ç®—æ¸²æŸ“æ•¸é‡

            for (const room of rooms) {
                const views = room.name === 'å®¢å»³' ? ['ä¸»æ²™ç™¼å€è¦–è§’', 'å¾å…¥å£çœ‹å‘å®¢å»³'] : [`${room.name}ä¸»è¦–è§’`];
                
                for (const view of views) {
                    completed++;
                    renderProgressEl.textContent = `æ­£åœ¨ç”Ÿæˆ ${room.name} - ${view} (${completed}/${Math.ceil(total)})`;

                    const renderPrompt = `${designer.promptTemplate}

SPECIFIC ROOM: ${room.name} - ${view}
Room Size: ${room.area}
Furniture: ${room.furniture.join(', ')}
Design notes: ${room.design_notes}

Color palette: ${designer.colorPalette.join(', ')}
Materials: ${designer.materials.join(', ')}
Keywords: ${designer.keywords.join(', ')}

Overall concept: ${state.layoutData.design_concept}

Technical requirements:
- Photorealistic interior rendering
- Eye-level camera angle, 24mm lens perspective
- Natural daylight from windows
- Professional architectural photography quality
- Show spatial depth and relationships
- Realistic shadows and reflections
- Warm inviting atmosphere
- High resolution details`;

                    try {
                        const base64Image = await generateImageWithGemini(renderPrompt);
                        state.renders.push({
                            space: room.name,
                            view: view,
                            imageUrl: `data:image/png;base64,${base64Image}`,
                            description: room.design_notes
                        });
                        
                        displayRender({
                            space: room.name,
                            view: view,
                            imageUrl: `data:image/png;base64,${base64Image}`,
                            description: room.design_notes
                        });
                    } catch (error) {
                        console.error(`${room.name} æ¸²æŸ“å¤±æ•—:`, error);
                    }

                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            displayDetails();
        }

        function displayRender(render) {
            const container = document.getElementById('renders-container');
            const item = document.createElement('div');
            item.className = 'render-item';
            item.innerHTML = `
                <img src="${render.imageUrl}" alt="${render.space} - ${render.view}" class="w-full h-64 object-cover">
                <div class="render-overlay">
                    <div>
                        <div class="font-bold">${render.space}</div>
                        <div class="text-sm">${render.view}</div>
                    </div>
                    <button onclick="downloadImage('${render.imageUrl}', '${render.space}-${render.view}')" class="text-white hover:text-blue-300">
                        ğŸ’¾
                    </button>
                </div>
            `;
            container.appendChild(item);
        }

        function displayDetails() {
            document.getElementById('design-concept').textContent = state.layoutData.design_concept;

            const colorScheme = document.getElementById('color-scheme');
            colorScheme.innerHTML = state.layoutData.color_scheme.map(color => 
                `<span class="px-4 py-2 bg-gray-200 rounded-full text-sm">${color}</span>`
            ).join('');

            const materialsList = document.getElementById('materials-list');
            materialsList.innerHTML = state.layoutData.material_suggestions.map(material => 
                `<li>${material}</li>`
            ).join('');

            const roomsList = document.getElementById('rooms-list');
            roomsList.innerHTML = state.layoutData.layout.rooms.map(room => `
                <div class="bg-white p-4 rounded-lg shadow">
                    <h6 class="font-bold mb-2">${room.name} (${room.area})</h6>
                    <p class="text-sm text-gray-600 mb-2">${room.design_notes}</p>
                    <div class="text-xs text-gray-500">
                        å‚¢ä¿±ï¼š${room.furniture.join('ã€')}
                    </div>
                </div>
            `).join('');
        }

        function downloadImage(dataUrl, filename) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = `${filename}-${Date.now()}.png`;
            a.click();
        }

        // å•Ÿå‹•
        init();
    </script>

</body>
</html>
