<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆ§ÂÖßË®≠Ë®àÈ†êË¶Ω</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1a1a2e;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%232a2a42' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E"),
                linear-gradient(rgba(26, 26, 46, 0.95), rgba(26, 26, 46, 0.95));
        }
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            color: #ffffff;
        }
        .app-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #12121e;
            border-radius: 0.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid #2a2a42;
        }
        .btn {
            transition: all 0.3s ease;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #165dff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0e42c3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 93, 255, 0.3);
        }
        .btn-disabled {
            background-color: #333842;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .style-card {
            border: 2px solid #2a2a42;
            border-radius: 0.5rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #1a1a2e;
            color: #ffffff;
        }
        .style-card:hover {
            border-color: #165dff;
            box-shadow: 0 6px 15px rgba(22, 93, 255, 0.2);
            transform: translateY(-3px);
        }
        .style-card.selected {
            border-color: #165dff;
            background-color: #1e1e3a;
            box-shadow: 0 0 15px rgba(22, 93, 255, 0.25);
        }
        .render-type-card {
            border: 2px solid #2a2a42;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #1a1a2e;
            color: #ffffff;
            text-align: center;
        }
        .render-type-card:hover {
            border-color: #165dff;
            box-shadow: 0 6px 15px rgba(22, 93, 255, 0.2);
            transform: translateY(-3px);
        }
        .render-type-card.selected {
            border-color: #165dff;
            background-color: #1e1e3a;
            box-shadow: 0 0 15px rgba(22, 93, 255, 0.25);
        }
        .loader {
            border: 4px solid #2a2a42;
            border-top: 4px solid #165dff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-container {
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
            background-color: #1a1a2e;
            border: 1px solid #2a2a42;
        }
        .progress-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.25rem;
            background: #1a1a2e;
            border: 1px solid #2a2a42;
            color: #ffffff;
        }
        .progress-step.active {
            background: rgba(22, 93, 255, 0.1);
            border: 1px solid #165dff;
        }
        .progress-step.completed {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
        }
        .tab-button {
            padding: 1rem 2rem;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #888;
        }
        .tab-button:hover {
            color: #165dff;
        }
        .tab-button.active {
            color: #165dff;
            border-bottom-color: #165dff;
        }
        .render-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        .render-item {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            border: 1px solid #2a2a42;
        }
        .render-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.4);
        }
        .render-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            color: white;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .render-item:hover .render-overlay {
            opacity: 1;
        }
        #loading-message {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold mb-3" style="background: linear-gradient(135deg, #165dff 0%, #a855f7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                ÂÆ§ÂÖßË®≠Ë®àÈ†êË¶Ω
            </h1>
            <p class="text-gray-400 text-lg">Ëº∏ÂÖ•Âπ≥Èù¢Âúñ„ÄÅÂù™Êï∏„ÄÅÈ†êÁÆóÂíåÈ¢®Ê†ºÔºåËÆìÊàëÁÇ∫ÊÇ®Ë®≠Ë®à</p>
        </header>

        <!-- Ëº∏ÂÖ•Ë°®ÂñÆ -->
        <div id="input-section" class="mb-8">
            
            <!-- Âπ≥Èù¢Âúñ‰∏äÂÇ≥ÂçÄ -->
            <div class="mb-8">
                <h3 class="text-2xl font-bold mb-4">üìê ‰∏äÂÇ≥Âπ≥Èù¢Âúñ</h3>
                <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-lg p-8 border-2 border-dashed border-gray-700">
                    
                    <!-- ‰∏äÂÇ≥ÂçÄÂüü -->
                    <div id="upload-area" class="text-center cursor-pointer transition-all hover:bg-gray-800 p-8 rounded-lg">
                        <input type="file" id="floorplan-upload" accept="image/*" class="hidden">
                        <div class="text-6xl mb-4">üè†</div>
                        <h4 class="text-xl font-semibold text-gray-200 mb-2">ÈªûÊìäÊàñÊãñÊãΩ‰∏äÂÇ≥Âπ≥Èù¢Âúñ</h4>
                        <p class="text-gray-400 mb-4">ÊîØÊè¥ JPG, PNG Ê†ºÂºè</p>
                        <button type="button" onclick="document.getElementById('floorplan-upload').click()" 
                                class="btn btn-primary">
                            ÈÅ∏ÊìáÊ™îÊ°à
                        </button>
                    </div>

                    <!-- È†êË¶ΩÂçÄÂüü -->
                    <div id="upload-preview" class="hidden mt-6">
                        <div class="bg-gray-900 rounded-lg p-4 shadow-md border border-gray-700">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="font-semibold text-gray-200">‚úÖ Â∑≤‰∏äÂÇ≥ÁöÑÂπ≥Èù¢Âúñ</h5>
                                <button id="clear-upload" class="text-red-500 hover:text-red-400 font-semibold text-sm">
                                    üóëÔ∏è Ê∏ÖÈô§
                                </button>
                            </div>
                            <img id="floorplan-preview-img" src="" alt="Âπ≥Èù¢ÂúñÈ†êË¶Ω" class="w-full max-h-80 object-contain rounded-lg border-2 border-gray-700">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ê∏≤ÊüìÈ°ûÂûãÈÅ∏Êìá -->
            <div class="mb-8">
                <h3 class="text-2xl font-bold mb-4">üé® ÈÅ∏ÊìáÊ∏≤ÊüìÈ°ûÂûã</h3>
                <div class="grid grid-cols-2 gap-4" id="render-type-grid">
                    <!-- ÂãïÊÖãÁîüÊàê -->
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                
                <!-- Âù™Êï∏Ëº∏ÂÖ• -->
                <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
                    <label class="block text-lg font-semibold text-gray-200 mb-3">
                        üè† ÂÆ§ÂÖßÂù™Êï∏
                    </label>
                    <input 
                        type="number" 
                        id="square-meters" 
                        class="w-full p-4 border-2 border-gray-700 bg-gray-800 text-white rounded-lg text-xl focus:border-blue-500 focus:outline-none"
                        placeholder="‰æãÂ¶Ç: 30"
                        value="30"
                        min="10"
                        max="200"
                    />
                    <p class="text-sm text-gray-400 mt-2">
                        Á¥Ñ <span id="sqm-display">99</span> Âπ≥ÊñπÂÖ¨Â∞∫
                    </p>
                </div>

                <!-- È†êÁÆóËº∏ÂÖ• -->
                <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
                    <label class="block text-lg font-semibold text-gray-200 mb-3">
                        üí∞ Ë£ùÊΩ¢È†êÁÆó (NT$)
                    </label>
                    <input 
                        type="number" 
                        id="budget" 
                        class="w-full p-4 border-2 border-gray-700 bg-gray-800 text-white rounded-lg text-xl focus:border-blue-500 focus:outline-none"
                        placeholder="‰æãÂ¶Ç: 800000"
                        value="800000"
                        min="100000"
                        step="50000"
                    />
                    <p class="text-sm text-gray-400 mt-2">
                        Á¥ÑÊØèÂù™ <span id="budget-per-ping">27k</span>
                    </p>
                </div>
            </div>

            <!-- È¢®Ê†ºÈÅ∏Êìá -->
            <div class="mb-6">
                <h3 class="text-2xl font-bold mb-4">‚ú® ÈÅ∏ÊìáË®≠Ë®àÈ¢®Ê†º</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4" id="style-grid">
                    <!-- ÂãïÊÖãÁîüÊàê -->
                </div>
            </div>

            <!-- ÁîüÊàêÊåâÈàï -->
            <div class="text-center">
                <button 
                    id="generate-btn" 
                    class="btn btn-primary text-xl px-12 py-4 shadow-lg"
                >
                    üöÄ ÈñãÂßãÁîüÊàêË®≠Ë®àÊñπÊ°à
                </button>
            </div>
        </div>

        <!-- ÂÑ™ÈõÖÁöÑÁ≠âÂæÖÁï´Èù¢ -->
        <div id="loading-section" class="mb-8 hidden">
            <div class="flex flex-col items-center justify-center py-20">
                <div class="mb-8">
                    <!-- ÂãïÊÖã LOGO ÂãïÁï´ -->
                    <div class="relative w-32 h-32">
                        <div class="absolute inset-0 border-4 border-blue-500 rounded-full animate-ping opacity-75"></div>
                        <div class="absolute inset-0 border-4 border-blue-400 rounded-full animate-pulse"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-5xl">üè†</span>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-3xl font-bold mb-4 text-center">Ê≠£Âú®ÁÇ∫ÊÇ®Ë®≠Ë®àÂ§¢ÊÉ≥Á©∫Èñì</h3>
                <p class="text-gray-400 text-lg mb-8 text-center max-w-md" id="loading-message">
                    ÊàëÂÄëÊ≠£Âú®‰ªîÁ¥∞Á†îËÆÄÊÇ®ÁöÑÁ©∫Èñì...
                </p>
                
                <!-- ÂÑ™ÈõÖÁöÑÈÄ≤Â∫¶ÊåáÁ§∫ -->
                <div class="flex gap-3 mb-8">
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
                
                <div class="text-sm text-gray-500 text-center">
                    <p>È†êË®àÈúÄË¶Å 2-3 ÂàÜÈêò</p>
                    <p class="mt-2">Ë´ãÂãøÈóúÈñâÈ†ÅÈù¢</p>
                </div>
            </div>
        </div>

        <!-- ÁµêÊûúÈ°ØÁ§∫ -->
        <div id="result-section" class="hidden">
            <h3 class="text-3xl font-bold mb-6">‚ú® Ë®≠Ë®àÊàêÊûú</h3>
            
            <!-- Ê®ôÁ±§ÂàáÊèõ -->
            <div class="flex border-b-2 border-gray-700 mb-6">
                <button class="tab-button active" data-tab="floorplan">
                    üìê Âπ≥Èù¢ÈÖçÁΩÆÂúñ
                </button>
                <button class="tab-button" data-tab="renders">
                    üè† Á©∫ÈñìÊ∏≤ÊüìÂúñ
                </button>
            </div>

            <!-- Âπ≥Èù¢ÈÖçÁΩÆÂúñ -->
            <div id="tab-floorplan" class="tab-content">
                <div class="image-container bg-gray-900 flex items-center justify-center" style="min-height: 500px;">
                    <img id="floorplan-image" src="" alt="Âπ≥Èù¢ÈÖçÁΩÆÂúñ" class="max-w-full max-h-[700px] object-contain" style="display:none;">
                    <span id="floorplan-placeholder" class="text-gray-500">Âπ≥Èù¢ÂúñÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°</span>
                </div>
            </div>

            <!-- Á©∫ÈñìÊ∏≤ÊüìÂúñ -->
            <div id="tab-renders" class="tab-content hidden">
                <div id="renders-container" class="render-grid">
                    <!-- ÂãïÊÖãÁîüÊàêÊ∏≤ÊüìÂúñ -->
                </div>
            </div>

            <!-- Êìç‰ΩúÊåâÈàï -->
            <div class="mt-8 flex gap-4 justify-center">
                <button id="download-all-btn" class="btn bg-green-600 text-white hover:bg-green-700">
                    üíæ ‰∏ãËºâÂÖ®ÈÉ®ÂúñÁâá
                </button>
                <button id="regenerate-btn" class="btn bg-purple-600 text-white hover:bg-purple-700">
                    üîÑ ÈáçÊñ∞ÁîüÊàê
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================
        // Ë®≠Ë®àÂ∏´È¢®Ê†ºË≥áÊñôÂ∫´
        // ====================================
        const DESIGNER_STYLES = {
            'modern-minimalist': {
                id: 'modern-minimalist',
                label: 'Áèæ‰ª£Á∞°Á¥Ñ',
                emoji: '‚ö™',
                description: 'Á∞°ÊΩîÁ∑öÊ¢ù„ÄÅ‰∏≠ÊÄßËâ≤Ë™ø',
                designer: {
                    name: 'Vincent Van Duysen',
                    promptTemplate: `modern minimalist interior design, clean lines, neutral tones, natural materials, pale oak limestone linen, serene atmosphere, soft natural lighting, high-end architectural photography`
                }
            },
            'scandinavian': {
                id: 'scandinavian',
                label: 'ÂåóÊ≠êÈ¢®Ê†º',
                emoji: 'üå≤',
                description: 'Ê∫´ÊöñÊú®Ë≥™„ÄÅËá™ÁÑ∂Êé°ÂÖâ',
                designer: {
                    name: 'Studio McGee',
                    promptTemplate: `Scandinavian interior design, warm neutral palette, light wood tones, cozy textiles, natural light, comfortable elegance, plants, bright soft lighting`
                }
            },
            'luxury-modern': {
                id: 'luxury-modern',
                label: 'Áèæ‰ª£Â•¢ËèØ',
                emoji: 'üíé',
                description: 'Á≤æÁ∑ªÊùêË≥™„ÄÅÂÑ™ÈõÖËâ≤ÂΩ©',
                designer: {
                    name: 'Kelly Hoppen',
                    promptTemplate: `luxury modern interior design, sophisticated neutral palette, taupe cream grey, luxurious textures velvet silk marble, elegant lighting, opulent details, dramatic lighting`
                }
            },
            'industrial': {
                id: 'industrial',
                label: 'Â∑•Ê•≠È¢®Ê†º',
                emoji: 'üè≠',
                description: 'Ë£∏Èú≤ÊùêË≥™„ÄÅÂÄãÊÄßÁ©∫Èñì',
                designer: {
                    name: 'Nate Berkus',
                    promptTemplate: `industrial chic interior design, exposed materials, vintage elements, warm atmosphere, reclaimed wood leather metal, natural warm lighting`
                }
            },
            'japanese-zen': {
                id: 'japanese-zen',
                label: 'Êó•ÂºèÁ¶™È¢®',
                emoji: 'üéã',
                description: 'Ëá™ÁÑ∂Á¥†Êùê„ÄÅÂØßÈùúÊ∞õÂúç',
                designer: {
                    name: 'Axel Vervoordt',
                    promptTemplate: `Japanese zen interior design, wabi-sabi aesthetic, aged natural materials, muted earthy palette, organic textures, contemplative atmosphere, soft diffused lighting`
                }
            }
        };

        // Ê∏≤ÊüìÈ°ûÂûã
        const RENDER_TYPES = {
            '3d-bird-view': {
                id: '3d-bird-view',
                label: '3D ‰øØË¶ñÂúñ',
                emoji: 'ü¶Ö',
                description: 'Á´ãÈ´îÈ≥•Áû∞Ë¶ñËßí',
                promptSuffix: '3D architectural visualization, bird eye view perspective, isometric angle, showing interior layout from above, realistic materials and textures, professional render, soft ambient lighting, white background, clean composition'
            },
            '2d-floorplan': {
                id: '2d-floorplan',
                label: '2D Âπ≥Èù¢Âúñ',
                emoji: 'üìê',
                description: 'ÂÇ≥Áµ±Âπ≥Èù¢ÈÖçÁΩÆ',
                promptSuffix: '2D architectural floor plan, top-down view, clear room boundaries, furniture layout icons, professional CAD style, white background, clean lines, labeled rooms'
            }
        };

        // ====================================
        // ÁãÄÊÖãÁÆ°ÁêÜ
        // ====================================
        const state = {
            squareMeters: 30,
            budget: 800000,
            selectedStyle: 'modern-minimalist',
            selectedRenderType: '3d-bird-view',
            uploadedFloorplan: null,
            uploadedFileName: '',
            isGenerating: false,
            currentStep: 0,
            layoutData: null,
            floorplanImage: null,
            renders: []
        };

        // API Key
        const API_KEY = "AIzaSyBnficu4WvKraFrO0XJIOD95ZIYbM9aAgI";

        // ====================================
        // DOM ÂÖÉÁ¥†
        // ====================================
        const squareMetersInput = document.getElementById('square-meters');
        const budgetInput = document.getElementById('budget');
        const styleGrid = document.getElementById('style-grid');
        const renderTypeGrid = document.getElementById('render-type-grid');
        const generateBtn = document.getElementById('generate-btn');
        const floorplanUpload = document.getElementById('floorplan-upload');
        const uploadArea = document.getElementById('upload-area');
        const uploadPreview = document.getElementById('upload-preview');
        const floorplanPreviewImg = document.getElementById('floorplan-preview-img');
        const clearUploadBtn = document.getElementById('clear-upload');
        const inputSection = document.getElementById('input-section');
        const resultSection = document.getElementById('result-section');

        // ====================================
        // ÂàùÂßãÂåñ
        // ====================================
        function init() {
            renderStyleGrid();
            renderRenderTypeGrid();
            setupEventListeners();
            updateCalculations();
        }

        function renderStyleGrid() {
            styleGrid.innerHTML = '';
            Object.values(DESIGNER_STYLES).forEach(style => {
                const card = document.createElement('div');
                card.className = `style-card ${state.selectedStyle === style.id ? 'selected' : ''}`;
                card.innerHTML = `
                    <div class="text-4xl mb-2 text-center">${style.emoji}</div>
                    <h4 class="font-bold text-center mb-1">${style.label}</h4>
                    <p class="text-xs text-gray-400 text-center">${style.description}</p>
                `;
                card.onclick = () => selectStyle(style.id);
                styleGrid.appendChild(card);
            });
        }

        function renderRenderTypeGrid() {
            renderTypeGrid.innerHTML = '';
            Object.values(RENDER_TYPES).forEach(type => {
                const card = document.createElement('div');
                card.className = `render-type-card ${state.selectedRenderType === type.id ? 'selected' : ''}`;
                card.innerHTML = `
                    <div class="text-5xl mb-3">${type.emoji}</div>
                    <h4 class="font-bold mb-1">${type.label}</h4>
                    <p class="text-xs text-gray-400">${type.description}</p>
                `;
                card.onclick = () => selectRenderType(type.id);
                renderTypeGrid.appendChild(card);
            });
        }

        function selectStyle(styleId) {
            state.selectedStyle = styleId;
            renderStyleGrid();
        }

        function selectRenderType(typeId) {
            state.selectedRenderType = typeId;
            renderRenderTypeGrid();
        }

        function setupEventListeners() {
            squareMetersInput.addEventListener('input', updateCalculations);
            budgetInput.addEventListener('input', updateCalculations);
            generateBtn.addEventListener('click', startGeneration);

            // Âπ≥Èù¢Âúñ‰∏äÂÇ≥
            floorplanUpload.addEventListener('change', handleFloorplanUpload);
            clearUploadBtn.addEventListener('click', handleClearUpload);
            
            // ÊãñÊãΩ‰∏äÂÇ≥
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('bg-gray-800');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('bg-gray-800');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('bg-gray-800');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processFloorplanFile(file);
                }
            });

            // Ê®ôÁ±§ÂàáÊèõ
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    btn.classList.add('active');
                    document.getElementById(`tab-${tab}`).classList.remove('hidden');
                });
            });

            document.getElementById('regenerate-btn').addEventListener('click', () => {
                resultSection.classList.add('hidden');
                inputSection.classList.remove('hidden');
                state.currentStep = 0;
            });

            document.getElementById('download-all-btn').addEventListener('click', downloadAllImages);
        }

        function handleFloorplanUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFloorplanFile(file);
            }
        }

        function processFloorplanFile(file) {
            state.uploadedFileName = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                state.uploadedFloorplan = base64;
                
                uploadArea.classList.add('hidden');
                uploadPreview.classList.remove('hidden');
                floorplanPreviewImg.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleClearUpload() {
            state.uploadedFloorplan = null;
            state.uploadedFileName = '';
            floorplanUpload.value = '';
            uploadArea.classList.remove('hidden');
            uploadPreview.classList.add('hidden');
        }

        function updateCalculations() {
            state.squareMeters = parseFloat(squareMetersInput.value) || 0;
            state.budget = parseFloat(budgetInput.value) || 0;

            const sqm = (state.squareMeters * 3.306).toFixed(0);
            const budgetPerPing = state.squareMeters > 0 ? Math.round(state.budget / state.squareMeters / 1000) : 0;

            document.getElementById('sqm-display').textContent = sqm;
            document.getElementById('budget-per-ping').textContent = `${budgetPerPing}k`;
        }

        // ====================================
        // Gemini API Ë™øÁî®
        // ====================================
        async function generateImageWithGemini(prompt, base64ImageData = null, maxRetries = 2) {
            console.log("Calling Gemini API for image generation...");
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;

            const parts = [{ text: prompt }];
            if (base64ImageData) {
                parts.push({
                    inlineData: {
                        mimeType: "image/png",
                        data: base64ImageData
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE'],
                    temperature: 0.8,
                    maxOutputTokens: 2048
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ]
            };

            let lastError = null;

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`Attempt ${attempt + 1} API Error:`, errorBody);
                        lastError = new Error(`APIË´ãÊ±ÇÂ§±Êïó,ÁãÄÊÖãÁ¢º:${response.status}`);
                        
                        if (attempt < maxRetries) {
                            payload.contents[0].parts[0].text += ", professional architectural visualization, tasteful design";
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                        throw lastError;
                    }

                    const result = await response.json();
                    const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);

                    if (imagePart) {
                        console.log("Image successfully generated.");
                        return imagePart.inlineData.data;
                    } else {
                        lastError = new Error("APIÊú™ËøîÂõûÊúâÊïàÁöÑÂúñÁâáË≥áÊñô");
                        console.error("Invalid API response structure:", result);
                        if (attempt < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    lastError = error;
                    if (attempt < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }
            
            throw lastError;
        }

        async function callGeminiAPI(prompt, images = []) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`;

            const parts = [];
            
            if (images.length > 0) {
                images.forEach(base64 => {
                    parts.push({
                        inline_data: {
                            mime_type: "image/png",
                            data: base64
                        }
                    });
                });
            }
            
            parts.push({ text: prompt });

            const requestBody = {
                contents: [{
                    parts: parts
                }],
                generationConfig: {
                    temperature: 0.9,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API Ë™øÁî®Â§±Êïó');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // Á≠âÂæÖË®äÊÅØ
        const loadingMessages = [
            'ÊàëÂÄëÊ≠£Âú®‰ªîÁ¥∞Á†îËÆÄÊÇ®ÁöÑÁ©∫Èñì...',
            'ÁÇ∫ÊÇ®ÊßãÊÄùÊúÄËàíÈÅ©ÁöÑÁîüÊ¥ªÂãïÁ∑ö...',
            'ÊåëÈÅ∏ÊúÄÈÅ©ÂêàÁöÑËâ≤ÂΩ©ËàáÊùêË≥™...',
            'ÊâìÈÄ†ÊØèÂÄãËßíËêΩÁöÑÁç®ÁâπÊ∞õÂúç...',
            'ËÆìÂÖâÁ∑öÂú®Á©∫Èñì‰∏≠Ëá™ÁÑ∂ÊµÅÂãï...',
            'Âç≥Â∞áÁÇ∫ÊÇ®ÂëàÁèæÂÆåÊï¥Ë®≠Ë®àÊñπÊ°à...'
        ];
        let loadingMessageIndex = 0;
        let loadingInterval = null;

        // ====================================
        // ÁîüÊàêÊµÅÁ®ã
        // ====================================
        async function startGeneration() {
            if (state.isGenerating) return;
            
            if (!state.uploadedFloorplan) {
                alert('Ë´ãÂÖà‰∏äÂÇ≥Âπ≥Èù¢ÂúñÔºÅ');
                return;
            }

            state.isGenerating = true;
            generateBtn.classList.add('btn-disabled');
            generateBtn.textContent = 'ÁîüÊàê‰∏≠...';

            inputSection.classList.add('hidden');
            document.getElementById('loading-section').classList.remove('hidden');

            // ÈñãÂßãËº™Êí≠Á≠âÂæÖË®äÊÅØ
            startLoadingMessages();

            try {
                // Step 1: ÂàÜÊûêÁ©∫ÈñìÈúÄÊ±ÇÔºàÂæåÂè∞Âü∑Ë°åÔºâ
                await step1_analyzeSpace();

                // Step 2: ÁîüÊàêÂπ≥Èù¢ÂúñÔºàÂæåÂè∞Âü∑Ë°åÔºâ
                await step2_generateFloorplan();

                // Step 3: ÁîüÊàêÊ∏≤ÊüìÂúñÔºàÂæåÂè∞Âü∑Ë°åÔºâ
                await step3_generateRenders();

                // ÂÅúÊ≠¢Á≠âÂæÖË®äÊÅØ
                stopLoadingMessages();

                // È°ØÁ§∫ÁµêÊûú
                document.getElementById('loading-section').classList.add('hidden');
                resultSection.classList.remove('hidden');

            } catch (error) {
                console.error('ÁîüÊàêÂ§±Êïó:', error);
                stopLoadingMessages();
                alert(`ÁîüÊàêÂ§±Êïó: ${error.message}`);
                document.getElementById('loading-section').classList.add('hidden');
                inputSection.classList.remove('hidden');
            } finally {
                state.isGenerating = false;
                generateBtn.classList.remove('btn-disabled');
                generateBtn.textContent = 'üöÄ ÈñãÂßãÁîüÊàêË®≠Ë®àÊñπÊ°à';
            }
        }

        function startLoadingMessages() {
            loadingMessageIndex = 0;
            const messageEl = document.getElementById('loading-message');
            
            // Á´ãÂç≥È°ØÁ§∫Á¨¨‰∏ÄÊ¢ùË®äÊÅØ
            messageEl.textContent = loadingMessages[0];
            
            // ÊØè 5 ÁßíÂàáÊèõ‰∏ÄÊ¨°Ë®äÊÅØ
            loadingInterval = setInterval(() => {
                loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    messageEl.textContent = loadingMessages[loadingMessageIndex];
                    messageEl.style.opacity = '1';
                }, 300);
            }, 5000);
        }

        function stopLoadingMessages() {
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
        }

        async function step1_analyzeSpace() {
            const designer = DESIGNER_STYLES[state.selectedStyle].designer;
            
            const prompt = `Ë´ãÂàÜÊûêÈÄôÂºµÂÆ§ÂÖßÂπ≥Èù¢ÂúñÔºå‰∏¶ÁÇ∫‰ª•‰∏ãÊ¢ù‰ª∂Ë¶èÂäÉÁ©∫ÈñìÈÖçÁΩÆÔºö

Âü∫Êú¨Ë≥áË®äÔºö
- ÂÆ§ÂÖßÂù™Êï∏Ôºö${state.squareMeters} Âù™ÔºàÁ¥Ñ ${(state.squareMeters * 3.306).toFixed(1)} Âπ≥ÊñπÂÖ¨Â∞∫Ôºâ
- Ë£ùÊΩ¢È†êÁÆóÔºöNT$ ${state.budget.toLocaleString()}
- Ë®≠Ë®àÈ¢®Ê†ºÔºö${DESIGNER_STYLES[state.selectedStyle].label}

Ë´ã‰ªîÁ¥∞ÂàÜÊûêÂπ≥Èù¢Âúñ‰∏≠ÁöÑÊàøÈñìÊ†ºÂ±Ä„ÄÅÈñÄÁ™ó‰ΩçÁΩÆ„ÄÅÁ©∫ÈñìÂ∞∫ÂØ∏„ÄÅÂãïÁ∑öÈÖçÁΩÆÔºåÁÑ∂ÂæåÊèê‰æõÂÆåÊï¥ÁöÑÂÆ§ÂÖßË®≠Ë®àË¶èÂäÉÔºå‰ª• JSON Ê†ºÂºèÂõûÂÇ≥Ôºö
{
  "layout": {
    "total_area": "${state.squareMeters}Âù™",
    "rooms": [
      {
        "name": "ÂÆ¢Âª≥",
        "area": "10Âù™",
        "furniture": ["LÂûãÊ≤ôÁôº", "ÈõªË¶ñÊ´É", "Ëå∂Âá†"],
        "design_notes": "ÈñãÊîæÂºèË®≠Ë®à"
      }
    ]
  }
}`;

            const response = await callGeminiAPI(prompt, [state.uploadedFloorplan]);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                state.layoutData = JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('ÁÑ°Ê≥ïËß£ÊûêÁ©∫ÈñìÈÖçÁΩÆË≥áÊñô');
            }
        }

        async function step2_generateFloorplan() {
            const designer = DESIGNER_STYLES[state.selectedStyle].designer;
            const renderType = RENDER_TYPES[state.selectedRenderType];
            
            const roomsDesc = state.layoutData.layout.rooms.map(room => 
                `${room.name}Ôºà${room.area}Ôºâ`
            ).join('„ÄÅ');

            let floorplanPrompt = '';
            
            if (state.selectedRenderType === '3d-bird-view') {
                // 3D ‰øØË¶ñÂúñ prompt
                floorplanPrompt = `Create a stunning 3D architectural visualization of interior space from bird's eye view perspective.

Style: ${DESIGNER_STYLES[state.selectedStyle].label}
Designer inspiration: ${designer.name}
Total Area: ${(state.squareMeters * 3.306).toFixed(0)} square meters
Rooms: ${roomsDesc}

Requirements:
- 3D isometric or bird's eye view angle showing interior from above
- Photo-realistic materials and textures
- ${designer.promptTemplate}
- Show furniture and interior details in 3D
- Soft ambient lighting with natural shadows
- Clean white or neutral background
- Professional architectural visualization quality
- High detail and realistic rendering
- Clear spatial relationships between rooms

Ë´ãÁîüÊàêÂ¶ÇÂêåÂ∞àÊ•≠Âª∫ÁØâÂèØË¶ñÂåñÁöÑ 3D ‰øØË¶ñÊïàÊûúÂúñÔºåÂ±ïÁèæÁ©∫ÈñìÁöÑÁ´ãÈ´îÊÑüÂíåË®≠Ë®àÁæéÊÑü„ÄÇ`;
            } else {
                // 2D Âπ≥Èù¢Âúñ prompt
                floorplanPrompt = `Ë´ãÂâµÂª∫‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑ2DÂÆ§ÂÖßÂπ≥Èù¢ÈÖçÁΩÆÂúñÔºà‰øØË¶ñÂúñÔºâ„ÄÇ

Ë®≠Ë®àÈ¢®Ê†ºÔºö${DESIGNER_STYLES[state.selectedStyle].label}
Á∏ΩÈù¢Á©çÔºö${(state.squareMeters * 3.306).toFixed(0)} Âπ≥ÊñπÂÖ¨Â∞∫
Á©∫ÈñìÈÖçÁΩÆÔºö${roomsDesc}

ÂúñÈù¢Ë¶ÅÊ±ÇÔºö
‚Ä¢ Ê∏ÖÊô∞ÁöÑÊàøÈñìÈÇäÁïåÁ∑ö
‚Ä¢ Ê®ôË®ªÂêÑÊàøÈñìÂ∞∫ÂØ∏
‚Ä¢ ‰øØË¶ñËßíÂ∫¶ÁöÑÂÇ¢‰ø±ÈÖçÁΩÆÂúñÁ§∫
‚Ä¢ ÈñÄÁöÑÈñãÂïüÊñπÂêëÂíåÁ™óÊà∂‰ΩçÁΩÆ
‚Ä¢ ÊØî‰æãÂ∞∫ÂíåÊåáÂåóÈáù
‚Ä¢ ‰ΩøÁî®ÁπÅÈ´î‰∏≠ÊñáÊ∏ÖÊ•öÊ®ôË®ªÊàøÈñìÂêçÁ®±
‚Ä¢ Â∞àÊ•≠Âª∫ÁØâË£ΩÂúñÈ¢®Ê†º
‚Ä¢ ÁôΩËâ≤ËÉåÊôØÔºåÁ¥∞ÈªëÁ∑öÊ¢ù
‚Ä¢ ‰∏çÂêåÂçÄÂüüÁî®Ê∑°Ëâ≤ÂçÄÂàÜ`;
            }

            try {
                const base64Image = await generateImageWithGemini(floorplanPrompt, state.uploadedFloorplan);
                state.floorplanImage = `data:image/png;base64,${base64Image}`;
                
                const img = document.getElementById('floorplan-image');
                const placeholder = document.getElementById('floorplan-placeholder');
                img.src = state.floorplanImage;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            } catch (error) {
                console.error('Âπ≥Èù¢ÂúñÁîüÊàêÂ§±Êïó:', error);
                const img = document.getElementById('floorplan-image');
                const placeholder = document.getElementById('floorplan-placeholder');
                img.src = `data:image/png;base64,${state.uploadedFloorplan}`;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
        }

        async function step3_generateRenders() {
            const designer = DESIGNER_STYLES[state.selectedStyle].designer;
            const rooms = state.layoutData.layout.rooms;
            
            state.renders = [];
            let totalViews = 0;
            
            rooms.forEach(room => {
                totalViews += room.name === 'ÂÆ¢Âª≥' ? 2 : 1;
            });

            for (const room of rooms) {
                const views = room.name === 'ÂÆ¢Âª≥' ? ['‰∏ªÊ≤ôÁôºÂçÄË¶ñËßí', 'ÂæûÂÖ•Âè£ÁúãÂêëÂÆ¢Âª≥'] : [`${room.name}‰∏ªË¶ñËßí`];
                
                for (const view of views) {
                    // ÂæåÂè∞ÈùúÈªòÁîüÊàêÔºå‰∏çÈ°ØÁ§∫ÈÄ≤Â∫¶
                    const renderPrompt = `${designer.promptTemplate}. ROOM: ${room.name} ${view}. Size: ${room.area}. Furniture: ${room.furniture.join(' ')}. Photorealistic interior rendering, eye-level camera angle, natural daylight, professional architectural photography, spatial depth, realistic shadows, warm atmosphere, high resolution`;

                    try {
                        const base64Image = await generateImageWithGemini(renderPrompt);
                        state.renders.push({
                            space: room.name,
                            view: view,
                            imageUrl: `data:image/png;base64,${base64Image}`,
                            description: room.design_notes
                        });
                        
                        displayRender({
                            space: room.name,
                            view: view,
                            imageUrl: `data:image/png;base64,${base64Image}`,
                            description: room.design_notes
                        });
                    } catch (error) {
                        console.error(`${room.name} Ê∏≤ÊüìÂ§±Êïó:`, error);
                    }

                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }

        function displayRender(render) {
            const container = document.getElementById('renders-container');
            const item = document.createElement('div');
            item.className = 'render-item';
            item.innerHTML = `
                <img src="${render.imageUrl}" alt="${render.space} - ${render.view}" class="w-full h-64 object-cover">
                <div class="render-overlay">
                    <div>
                        <div class="font-bold">${render.space}</div>
                        <div class="text-sm">${render.view}</div>
                    </div>
                    <button onclick="downloadImage('${render.imageUrl}', '${render.space}-${render.view}')" class="text-white hover:text-blue-300">
                        üíæ
                    </button>
                </div>
            `;
            container.appendChild(item);
        }

        function downloadImage(dataUrl, filename) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = `${filename}-${Date.now()}.png`;
            a.click();
        }

        function downloadAllImages() {
            if (state.floorplanImage) {
                downloadImage(state.floorplanImage, 'Âπ≥Èù¢ÈÖçÁΩÆÂúñ');
            }

            state.renders.forEach((render, index) => {
                setTimeout(() => {
                    downloadImage(render.imageUrl, `${render.space}-${render.view}`);
                }, index * 500);
            });
        }

        // ÂïüÂãï
        init();
    </script>

</body>
</html>
