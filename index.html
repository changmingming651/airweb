<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¤å…§è¨­è¨ˆé è¦½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1a1a2e;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%232a2a42' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E"),
                linear-gradient(rgba(26, 26, 46, 0.95), rgba(26, 26, 46, 0.95));
        }
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            color: #ffffff;
        }
        .app-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #12121e;
            border-radius: 0.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid #2a2a42;
        }
        .btn {
            transition: all 0.3s ease;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #165dff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0e42c3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 93, 255, 0.3);
        }
        .btn-disabled {
            background-color: #333842;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .style-card {
            border: 2px solid #2a2a42;
            border-radius: 0.5rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #1a1a2e;
            color: #ffffff;
            background-image: linear-gradient(rgba(26, 26, 46, 0.9), rgba(26, 26, 46, 0.9)), url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%238b7765' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .style-card:hover {
            border-color: #165dff;
            box-shadow: 0 6px 15px rgba(22, 93, 255, 0.2);
            transform: translateY(-3px);
        }
        .style-card.selected {
            border-color: #165dff;
            background-color: #1e1e3a;
            box-shadow: 0 0 15px rgba(22, 93, 255, 0.25);
        }
        .loader {
            border: 4px solid #2a2a42;
            border-top: 4px solid #165dff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-container {
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
            background-color: #1a1a2e;
            border: 1px solid #2a2a42;
        }
        .progress-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.25rem;
            background: #1a1a2e;
            border: 1px solid #2a2a42;
            color: #ffffff;
        }
        .progress-step.active {
            background-color: #1e1e3a;
            border: 1px solid #165dff;
        }
        .progress-step.completed {
            background-color: #1a2e2a;
            border: 1px solid #0e9f6e;
        }
        .tab-button {
            padding: 1rem 2rem;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #b0b0c0;
        }
        .tab-button:hover {
            color: #165dff;
        }
        .tab-button.active {
            color: #165dff;
            border-bottom-color: #165dff;
        }
        .render-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        .render-item {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            border: 1px solid #2a2a42;
        }
        .render-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        .render-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            color: white;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .render-item:hover .render-overlay {
            opacity: 1;
        }
        .upload-area {
            border: 2px dashed #2a2a42;
            background-color: #1a1a2e;
            color: #ffffff;
        }
        .upload-area:hover {
            background-color: #1e1e3a;
            border-color: #165dff;
        }
        p, label, span, div {
            color: #e0e0e8;
        }
        input {
            background-color: #2a2a42 !important;
            border-color: #3a3a52 !important;
            color: #ffffff !important;
        }
        input::placeholder {
            color: #8080a0 !important;
        }
        .text-gray-500, .text-gray-600 {
            color: #8080a0 !important;
        }
        .text-gray-700, .text-gray-800 {
            color: #e0e0e8 !important;
        }
        .bg-gray-50 {
            background-color: #1a1a2e !important;
            border-color: #2a2a42 !important;
        }
        .bg-white {
            background-color: #1e1e3a !important;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold mb-3">
                å®¤å…§è¨­è¨ˆé è¦½
            </h1>
            <p class="text-gray-400 text-lg">è¼¸å…¥å¹³é¢åœ–ã€åªæ•¸ã€é ç®—å’Œé¢¨æ ¼ï¼Œè®“æˆ‘ç‚ºæ‚¨è¨­è¨ˆ</p>
        </header>

        <!-- è¼¸å…¥è¡¨å–® -->
        <div id="input-section" class="mb-8">
            
            <!-- å¹³é¢åœ–ä¸Šå‚³å€ -->
            <div class="mb-8">
                <h3 class="text-2xl font-bold mb-4">ğŸ“ ä¸Šå‚³å¹³é¢åœ–</h3>
                <div class="bg-gray-50 rounded-xl p-8 border">
                    
                    <!-- ä¸Šå‚³å€åŸŸ -->
                    <div id="upload-area" class="text-center cursor-pointer transition-all p-8 rounded-lg">
                        <input type="file" id="floorplan-upload" accept="image/*" class="hidden">
                        <div class="text-6xl mb-4">ğŸ </div>
                        <h4 class="text-xl font-semibold mb-2">é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³å¹³é¢åœ–</h4>
                        <p class="text-gray-500 mb-4">æ”¯æ´ JPG, PNG æ ¼å¼</p>
                        <button type="button" onclick="document.getElementById('floorplan-upload').click()" 
                                class="btn bg-gray-700 text-white hover:bg-gray-800">
                            é¸æ“‡æª”æ¡ˆ
                        </button>
                    </div>

                    <!-- é è¦½å€åŸŸ -->
                    <div id="upload-preview" class="hidden mt-6">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="font-semibold">âœ… å·²ä¸Šå‚³çš„å¹³é¢åœ–</h5>
                                <button id="clear-upload" class="text-red-400 hover:text-red-300 font-semibold text-sm">
                                    ğŸ—‘ï¸ æ¸…é™¤
                                </button>
                            </div>
                            <img id="floorplan-preview-img" src="" alt="å¹³é¢åœ–é è¦½" class="w-full max-h-80 object-contain rounded-lg border border-gray-700">
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                
                <!-- åªæ•¸è¼¸å…¥ -->
                <div class="bg-gray-50 p-6 rounded-xl border">
                    <label class="block text-lg font-semibold mb-3">
                        ğŸ  å®¤å…§åªæ•¸
                    </label>
                    <input 
                        type="number" 
                        id="square-meters" 
                        class="w-full p-4 border rounded-lg text-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none"
                        placeholder="ä¾‹å¦‚: 30"
                        value="30"
                        min="10"
                        max="200"
                    />
                    <p class="text-sm text-gray-500 mt-2">
                        ç´„ <span id="sqm-display">99</span> å¹³æ–¹å…¬å°º
                    </p>
                </div>

                <!-- é ç®—è¼¸å…¥ -->
                <div class="bg-gray-50 p-6 rounded-xl border">
                    <label class="block text-lg font-semibold mb-3">
                        ğŸ’° è£æ½¢é ç®— (NT$)
                    </label>
                    <input 
                        type="number" 
                        id="budget" 
                        class="w-full p-4 border rounded-lg text-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none"
                        placeholder="ä¾‹å¦‚: 800000"
                        value="800000"
                        min="100000"
                        step="50000"
                    />
                    <p class="text-sm text-gray-500 mt-2">
                        ç´„æ¯åª <span id="budget-per-ping">27k</span>
                    </p>
                </div>
            </div>

            <!-- é¢¨æ ¼é¸æ“‡ -->
            <div class="mb-6">
                <h3 class="text-2xl font-bold mb-4">ğŸ¨ é¸æ“‡è¨­è¨ˆé¢¨æ ¼</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4" id="style-grid">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ç”ŸæˆæŒ‰éˆ• -->
            <div class="text-center">
                <button 
                    id="generate-btn" 
                    class="btn btn-primary text-xl px-12 py-4 shadow-md"
                >
                    ğŸš€ é–‹å§‹ç”Ÿæˆè¨­è¨ˆæ–¹æ¡ˆ
                </button>
            </div>
        </div>

        <!-- é€²åº¦é¡¯ç¤º -->
        <div id="progress-section" class="mb-8 hidden">
            <h3 class="text-2xl font-bold mb-4">â³ ç”Ÿæˆé€²åº¦</h3>
            
            <div class="progress-step" id="step-1">
                <div class="flex items-center flex-1">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center mr-4 font-bold">1</div>
                    <div>
                        <div class="font-semibold">åˆ†æå¹³é¢åœ–ä¸¦è¦åŠƒç©ºé–“</div>
                        <div class="text-sm text-gray-400">æ ¹æ“šåªæ•¸å’Œé ç®—è¦åŠƒè¨­è¨ˆæ–¹æ¡ˆ</div>
                    </div>
                </div>
                <div class="loader hidden" id="loader-1"></div>
            </div>

            <div class="progress-step" id="step-2">
                <div class="flex items-center flex-1">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center mr-4 font-bold">2</div>
                    <div>
                        <div class="font-semibold">ç”Ÿæˆå¹³é¢é…ç½®åœ–</div>
                        <div class="text-sm text-gray-400">å‰µå»ºå¸¶å‚¢ä¿±çš„å®¤å…§å¹³é¢åœ–</div>
                    </div>
                </div>
                <div class="loader hidden" id="loader-2"></div>
            </div>

            <div class="progress-step" id="step-3">
                <div class="flex items-center flex-1">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center mr-4 font-bold">3</div>
                    <div>
                        <div class="font-semibold">ç”Ÿæˆç©ºé–“æ¸²æŸ“åœ–</div>
                        <div class="text-sm text-gray-400" id="render-progress">æº–å‚™ç”Ÿæˆå„ç©ºé–“çš„å¯«å¯¦æ•ˆæœåœ–</div>
                    </div>
                </div>
                <div class="loader hidden" id="loader-3"></div>
            </div>
        </div>

        <!-- çµæœé¡¯ç¤º -->
        <div id="result-section" class="hidden">
            <h3 class="text-3xl font-bold mb-6">âœ¨ è¨­è¨ˆæˆæœ</h3>
            
            <!-- æ¨™ç±¤åˆ‡æ› -->
            <div class="flex border-b border-gray-700 mb-6">
                <button class="tab-button active" data-tab="floorplan">
                    ğŸ“ å¹³é¢é…ç½®åœ–
                </button>
                <button class="tab-button" data-tab="renders">
                    ğŸ  ç©ºé–“æ¸²æŸ“åœ–
                </button>
            </div>

            <!-- å¹³é¢é…ç½®åœ– -->
            <div id="tab-floorplan" class="tab-content">
                <div class="image-container flex items-center justify-center" style="min-height: 500px;">
                    <img id="floorplan-image" src="" alt="å¹³é¢é…ç½®åœ–" class="max-w-full max-h-[700px] object-contain" style="display:none;">
                    <span id="floorplan-placeholder" class="text-gray-500">å¹³é¢åœ–å°‡é¡¯ç¤ºåœ¨é€™è£¡</span>
                </div>
            </div>

            <!-- ç©ºé–“æ¸²æŸ“åœ– -->
            <div id="tab-renders" class="tab-content hidden">
                <div id="renders-container" class="render-grid">
                    <!-- å‹•æ…‹ç”Ÿæˆæ¸²æŸ“åœ– -->
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="mt-8 flex gap-4 justify-center">
                <button id="download-all-btn" class="btn bg-green-700 text-white hover:bg-green-800">
                    ğŸ’¾ ä¸‹è¼‰å…¨éƒ¨åœ–ç‰‡
                </button>
                <button id="regenerate-btn" class="btn bg-gray-700 text-white hover:bg-gray-800">
                    ğŸ”„ é‡æ–°ç”Ÿæˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================
        // è¨­è¨ˆå¸«é¢¨æ ¼è³‡æ–™åº«
        // ====================================
        const DESIGNER_STYLES = {
            'modern-minimalist': {
                id: 'modern-minimalist',
                label: 'ç¾ä»£ç°¡ç´„',
                emoji: 'âšª',
                description: 'ç°¡æ½”ç·šæ¢ã€ä¸­æ€§è‰²èª¿',
                designer: {
                    name: 'Vincent Van Duysen',
                    colorPalette: ['ç±³ç™½è‰²', 'æ·ºç°è‰²', 'æ·ºæœ¨è‰²', 'çŸ³ç°è‰²'],
                    materials: ['å¤©ç„¶æ©¡æœ¨', 'çŸ³ç°å²©', 'äºéº»å¸ƒ', 'æ‹‰çµ²é‹¼'],
                    keywords: [
                        'minimalist purity',
                        'natural materials',
                        'subtle textures',
                        'timeless elegance',
                        'monochromatic palette',
                        'serene calm atmosphere'
                    ],
                    promptTemplate: `Interior design by Vincent Van Duysen style, pure minimalist aesthetic with timeless appeal, natural materials pale oak limestone raw linen, monochromatic neutral color scheme, clean architectural lines with subtle textural variations, abundance of natural light creating serene atmosphere, high-end architectural photography, soft natural light`
                }
            },
            'scandinavian': {
                id: 'scandinavian',
                label: 'åŒ—æ­é¢¨æ ¼',
                emoji: 'ğŸŒ²',
                description: 'æº«æš–æœ¨è³ªã€è‡ªç„¶æ¡å…‰',
                designer: {
                    name: 'Studio McGee',
                    colorPalette: ['æº«æš–ç™½', 'ç°è¤è‰²', 'æ·ºè—è‰²', 'å¤©ç„¶æœ¨è‰²'],
                    materials: ['æ·ºæ©¡æœ¨', 'äºéº»å¸ƒ', 'è—¤ç·¨', 'å¤©ç„¶çº–ç¶­'],
                    keywords: [
                        'Scandinavian modern',
                        'warm neutral palette',
                        'light wood tones',
                        'cozy textiles',
                        'natural light',
                        'comfortable elegance'
                    ],
                    promptTemplate: `Interior design by Studio McGee Scandinavian style, refined casual elegance with Nordic influence, warm neutral colors with light wood tones, layered natural textiles and cozy elements, abundant natural light in airy spaces, mix of modern and organic elements, plants and natural accessories, professional lifestyle photography, bright soft lighting`
                }
            },
            'luxury-modern': {
                id: 'luxury-modern',
                label: 'ç¾ä»£å¥¢è¯',
                emoji: 'ğŸ’',
                description: 'ç²¾ç·»æè³ªã€å„ªé›…è‰²å½©',
                designer: {
                    name: 'Kelly Hoppen',
                    colorPalette: ['é§è‰²', 'å¥¶æ²¹è‰²', 'æŸ”ç°è‰²', 'é‡‘è‰²é»ç¶´'],
                    materials: ['å¤©éµçµ¨', 'çµ²ç¶¢', 'æ‹‹å…‰å¤§ç†çŸ³', 'é»ƒéŠ…', 'çƒ¤æ¼†'],
                    keywords: [
                        'luxurious sophistication',
                        'symmetrical layout',
                        'neutral tones',
                        'opulent textures',
                        'layered lighting',
                        'East-West fusion'
                    ],
                    promptTemplate: `Interior design by Kelly Hoppen luxury style, sophisticated neutral palette with taupe cream soft grey, luxurious textures velvet silk polished marble, perfect symmetry and balanced composition, subtle East-meets-West fusion elements, layered ambient lighting with warm elegant glow, clean lines with opulent details, high-end interior photography, dramatic elegant lighting`
                }
            },
            'industrial': {
                id: 'industrial',
                label: 'å·¥æ¥­é¢¨æ ¼',
                emoji: 'ğŸ­',
                description: 'è£¸éœ²æè³ªã€å€‹æ€§ç©ºé–“',
                designer: {
                    name: 'Nate Berkus',
                    colorPalette: ['æº«æš–ä¸­æ€§è‰²', 'æ·±è—è‰²', 'é™¶åœŸè‰²', 'æ©„æ¬–ç¶ '],
                    materials: ['å›æ”¶æœ¨æ', 'äºéº»å¸ƒ', 'å¾©å¤é»ƒéŠ…', 'çš®é©'],
                    keywords: [
                        'industrial chic',
                        'exposed materials',
                        'vintage elements',
                        'warm inviting atmosphere',
                        'collected pieces',
                        'comfortable luxury'
                    ],
                    promptTemplate: `Interior design by Nate Berkus Industrial style, warm industrial aesthetic with collected touches, mix of vintage and contemporary pieces, exposed brick metal reclaimed wood, layered textiles linen leather woven fabrics, rich warm color palette with character, personal artifacts and meaningful objects, editorial interior photography, natural warm lighting`
                }
            },
            'japanese-zen': {
                id: 'japanese-zen',
                label: 'æ—¥å¼ç¦ªé¢¨',
                emoji: 'ğŸ‹',
                description: 'è‡ªç„¶ç´ æã€å¯§éœæ°›åœ',
                designer: {
                    name: 'Axel Vervoordt',
                    colorPalette: ['åŸå§‹ç°', 'å¤©ç„¶ç±³', 'é¢¨åŒ–ç™½', 'å¤§åœ°è‰²èª¿'],
                    materials: ['è€åŒ–æœ¨æ', 'æ¸…æ°´æ··å‡åœŸ', 'å¤©ç„¶çŸ³æ', 'å¤è‘£ç¹”å“'],
                    keywords: [
                        'wabi-sabi philosophy',
                        'aged patina',
                        'organic materials',
                        'spiritual minimalism',
                        'raw textures',
                        'contemplative atmosphere'
                    ],
                    promptTemplate: `Interior design by Axel Vervoordt Japanese Zen, wabi-sabi aesthetic celebrating imperfection, aged weathered materials with beautiful patina, muted earthy color palette, mix of ancient and contemporary elements, raw organic textures and natural materials, spiritual contemplative atmosphere, fine art photography, soft diffused natural lighting`
                }
            }
        };

        // ====================================
        // ç‹€æ…‹ç®¡ç†
        // ====================================
        const state = {
            squareMeters: 30,
            budget: 800000,
            selectedStyle: 'modern-minimalist',
            uploadedFloorplan: null,
            uploadedFileName: '',
            isGenerating: false,
            currentStep: 0,
            layoutData: null,
            floorplanImage: null,
            renders: []
        };

        // API Key
        const API_KEY = "AIzaSyBnficu4WvKraFrO0XJIOD95ZIYbM9aAgI";

        // ====================================
        // DOM å…ƒç´ 
        // ====================================
        const squareMetersInput = document.getElementById('square-meters');
        const budgetInput = document.getElementById('budget');
        const styleGrid = document.getElementById('style-grid');
        const generateBtn = document.getElementById('generate-btn');
        const floorplanUpload = document.getElementById('floorplan-upload');
        const uploadArea = document.getElementById('upload-area');
        const uploadPreview = document.getElementById('upload-preview');
        const floorplanPreviewImg = document.getElementById('floorplan-preview-img');
        const clearUploadBtn = document.getElementById('clear-upload');
        const inputSection = document.getElementById('input-section');
        const progressSection = document.getElementById('progress-section');
        const resultSection = document.getElementById('result-section');

        // ====================================
        // åˆå§‹åŒ–
        // ====================================
        function init() {
            renderStyleGrid();
            setupEventListeners();
            updateCalculations();
        }

        function renderStyleGrid() {
            styleGrid.innerHTML = '';
            Object.values(DESIGNER_STYLES).forEach(style => {
                const card = document.createElement('div');
                card.className = `style-card ${state.selectedStyle === style.id ? 'selected' : ''}`;
                card.innerHTML = `
                    <div class="text-4xl mb-2 text-center">${style.emoji}</div>
                    <h4 class="font-bold text-center mb-1">${style.label}</h4>
                    <p class="text-xs text-gray-400 text-center">${style.description}</p>
                `;
                card.onclick = () => selectStyle(style.id);
                styleGrid.appendChild(card);
            });
        }

        function selectStyle(styleId) {
            state.selectedStyle = styleId;
            renderStyleGrid();
        }

        function setupEventListeners() {
            squareMetersInput.addEventListener('input', updateCalculations);
            budgetInput.addEventListener('input', updateCalculations);
            generateBtn.addEventListener('click', startGeneration);

            // å¹³é¢åœ–ä¸Šå‚³
            floorplanUpload.addEventListener('change', handleFloorplanUpload);
            clearUploadBtn.addEventListener('click', handleClearUpload);
            
            // æ‹–æ‹½ä¸Šå‚³
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('bg-gray-800');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('bg-gray-800');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('bg-gray-800');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processFloorplanFile(file);
                }
            });

            // æ¨™ç±¤åˆ‡æ›
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    btn.classList.add('active');
                    document.getElementById(`tab-${tab}`).classList.remove('hidden');
                });
            });

            document.getElementById('regenerate-btn').addEventListener('click', () => {
                resultSection.classList.add('hidden');
                inputSection.classList.remove('hidden');
                state.currentStep = 0;
            });

            document.getElementById('download-all-btn').addEventListener('click', downloadAllImages);
        }

        function handleFloorplanUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFloorplanFile(file);
            }
        }

        function processFloorplanFile(file) {
            state.uploadedFileName = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                state.uploadedFloorplan = base64;
                
                uploadArea.classList.add('hidden');
                uploadPreview.classList.remove('hidden');
                floorplanPreviewImg.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleClearUpload() {
            state.uploadedFloorplan = null;
            state.uploadedFileName = '';
            floorplanUpload.value = '';
            uploadArea.classList.remove('hidden');
            uploadPreview.classList.add('hidden');
        }

        function updateCalculations() {
            state.squareMeters = parseFloat(squareMetersInput.value) || 0;
            state.budget = parseFloat(budgetInput.value) || 0;

            const sqm = (state.squareMeters * 3.306).toFixed(0);
            const budgetPerPing = state.squareMeters > 0 ? Math.round(state.budget / state.squareMeters / 1000) : 0;

            document.getElementById('sqm-display').textContent = sqm;
            document.getElementById('budget-per-ping').textContent = `${budgetPerPing}k`;
        }

        // ====================================
        // Gemini API èª¿ç”¨
        // ====================================
        async function generateImageWithGemini(prompt, base64ImageData = null, maxRetries = 2) {
            console.log("Calling Gemini API for image generation...");
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;

            const parts = [{ text: prompt }];
            if (base64ImageData) {
                parts.push({
                    inlineData: {
                        mimeType: "image/png",
                        data: base64ImageData
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE'],
                    temperature: 0.8,
                    maxOutputTokens: 2048
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ]
            };

            let lastError = null;

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`Attempt ${attempt + 1} API Error:`, errorBody);
                        lastError = new Error(`APIè«‹æ±‚å¤±æ•—,ç‹€æ…‹ç¢¼:${response.status}`);
                        
                        if (attempt < maxRetries && (errorBody.includes("safety") || errorBody.includes("policy"))) {
                            console.log("Safety filter triggered. Retrying with enhanced prompt...");
                            payload.contents[0].parts[0].text += ", professional architectural photography, SFW, tasteful design";
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                        throw lastError;
                    }

                    const result = await response.json();
                    const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);

                    if (imagePart) {
                        console.log("Image successfully generated.");
                        return imagePart.inlineData.data;
                    } else {
                        lastError = new Error("APIæœªè¿”å›æœ‰æ•ˆçš„åœ–ç‰‡è³‡æ–™");
                        console.error("Invalid API response structure:", result);
                        if (attempt < maxRetries) {
                            console.log("Retrying...");
                            payload.contents[0].parts[0].text += ", high quality render";
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    lastError = error;
                    if (attempt < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }
            
            throw lastError;
        }

        async function callGeminiAPI(prompt, images = []) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`;

            const parts = [];
            
            if (images.length > 0) {
                images.forEach(base64 => {
                    parts.push({
                        inline_data: {
                            mime_type: "image/png",
                            data: base64
                        }
                    });
                });
            }
            
            parts.push({ text: prompt });

            const requestBody = {
                contents: [{
                    parts: parts
                }],
                generationConfig: {
                    temperature: 0.9,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API èª¿ç”¨å¤±æ•—');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // ====================================
        // ç”Ÿæˆæµç¨‹
        // ====================================
        async function startGeneration() {
            if (state.isGenerating) return;
            
            if (!state.uploadedFloorplan) {
                alert('è«‹å…ˆä¸Šå‚³å¹³é¢åœ–ï¼');
                return;
            }

            state.isGenerating = true;
            generateBtn.classList.add('btn-disabled');
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';

            inputSection.classList.add('hidden');
            progressSection.classList.remove('hidden');

            try {
                // Step 1: åˆ†æç©ºé–“éœ€æ±‚
                await updateProgress(1, 'active');
                await step1_analyzeSpace();
                await updateProgress(1, 'completed');

                // Step 2: ç”Ÿæˆå¹³é¢åœ–
                await updateProgress(2, 'active');
                await step2_generateFloorplan();
                await updateProgress(2, 'completed');

                // Step 3: ç”Ÿæˆæ¸²æŸ“åœ–
                await updateProgress(3, 'active');
                await step3_generateRenders();
                await updateProgress(3, 'completed');

                // é¡¯ç¤ºçµæœ
                progressSection.classList.add('hidden');
                resultSection.classList.remove('hidden');

            } catch (error) {
                console.error('ç”Ÿæˆå¤±æ•—:', error);
                alert(`ç”Ÿæˆå¤±æ•—: ${error.message}`);
                progressSection.classList.add('hidden');
                inputSection.classList.remove('hidden');
            } finally {
                state.isGenerating = false;
                generateBtn.classList.remove('btn-disabled');
                generateBtn.textContent = 'ğŸš€ é–‹å§‹ç”Ÿæˆè¨­è¨ˆæ–¹æ¡ˆ';
            }
        }

        async function updateProgress(step, status) {
            const stepEl = document.getElementById(`step-${step}`);
            const loaderEl = document.getElementById(`loader-${step}`);

            if (status === 'active') {
                stepEl.classList.add('active');
                loaderEl.classList.remove('hidden');
            } else if (status === 'completed') {
                stepEl.classList.remove('active');
                stepEl.classList.add('completed');
                loaderEl.classList.add('hidden');
                const numberDiv = stepEl.querySelector('.w-10');
                numberDiv.textContent = 'âœ“';
                numberDiv.classList.add('bg-green-600', 'text-white');
            }
        }

        async function step1_analyzeSpace() {
            const designer = DESIGNER_STYLES[state.selectedStyle].designer;
            
            const prompt = `è«‹åˆ†æé€™å¼µå®¤å…§å¹³é¢åœ–ï¼Œä¸¦ç‚ºä»¥ä¸‹æ¢ä»¶è¦åŠƒç©ºé–“é…ç½®ï¼š

åŸºæœ¬è³‡è¨Šï¼š
- å®¤å…§åªæ•¸ï¼š${state.squareMeters} åªï¼ˆç´„ ${(state.squareMeters * 3.306).toFixed(1)} å¹³æ–¹å…¬å°ºï¼‰
- è£æ½¢é ç®—ï¼šNT$ ${state.budget.toLocaleString()}
- è¨­è¨ˆé¢¨æ ¼ï¼š${DESIGNER_STYLES[state.selectedStyle].label}
- è¨­è¨ˆå¸«åƒè€ƒï¼š${designer.name}

è«‹ä»”ç´°åˆ†æå¹³é¢åœ–ä¸­çš„ï¼š
1. æˆ¿é–“æ ¼å±€å’Œæ•¸é‡
2. é–€çª—ä½ç½®
3. ç©ºé–“å°ºå¯¸æ¯”ä¾‹
4. å‹•ç·šé…ç½®

ç„¶å¾Œæä¾›å®Œæ•´çš„å®¤å…§è¨­è¨ˆè¦åŠƒï¼Œä»¥ JSON æ ¼å¼å›å‚³ï¼š
{
  "layout": {
    "total_area": "${state.squareMeters}åª",
    "rooms": [
      {
        "name": "å®¢å»³",
        "area": "10åª",
        "furniture": ["Lå‹æ²™ç™¼", "é›»è¦–æ«ƒ", "èŒ¶å‡ ", "é‚Šå‡ "],
        "features": ["è½åœ°çª—", "ä¸»è¦æ¡å…‰é¢"],
        "design_notes": "é–‹æ”¾å¼è¨­è¨ˆï¼Œé€£æ¥é¤å»³"
      }
    ]
  },
  "design_concept": "æ ¹æ“šå¹³é¢åœ–åˆ†æï¼Œæä¾›æ•´é«”è¨­è¨ˆæ¦‚å¿µçš„è©³ç´°èªªæ˜ï¼ˆè‡³å°‘150å­—ï¼‰"
}

è«‹ç¢ºä¿:
1. æ ¹æ“šå¯¦éš›å¹³é¢åœ–çš„æ ¼å±€é€²è¡Œåˆ†æ
2. è€ƒæ…®åªæ•¸å’Œé ç®—é¸æ“‡åˆé©çš„è¨­è¨ˆæ–¹æ¡ˆ
3. å®Œå…¨ç¬¦åˆ${DESIGNER_STYLES[state.selectedStyle].label}é¢¨æ ¼ç‰¹é»`;

            const response = await callGeminiAPI(prompt, [state.uploadedFloorplan]);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                state.layoutData = JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('ç„¡æ³•è§£æç©ºé–“é…ç½®è³‡æ–™');
            }
        }

        async function step2_generateFloorplan() {
            const designer = DESIGNER_STYLES[state.selectedStyle].designer;
            
            const roomsDesc = state.layoutData.layout.rooms.map(room => 
                `${room.name}ï¼ˆ${room.area}ï¼‰`
            ).join('ã€');

            const floorplanPrompt = `è«‹å‰µå»ºä¸€å€‹å°ˆæ¥­çš„å®¤å…§å¹³é¢é…ç½®åœ–ï¼ˆä¿¯è¦–åœ–ï¼‰ã€‚

è¨­è¨ˆé¢¨æ ¼ï¼š${DESIGNER_STYLES[state.selectedStyle].label}
ç¸½é¢ç©ï¼š${(state.squareMeters * 3.306).toFixed(0)} å¹³æ–¹å…¬å°º

ç©ºé–“é…ç½®ï¼š${state.layoutData.layout.rooms.map(room => `${room.name} ${room.area}`).join('ã€')}

åœ–é¢è¦æ±‚ï¼š
â€¢ æ¸…æ™°çš„æˆ¿é–“é‚Šç•Œç·š
â€¢ æ¨™è¨»å„æˆ¿é–“å°ºå¯¸
â€¢ ä¿¯è¦–è§’åº¦çš„å‚¢ä¿±é…ç½®
â€¢ é–€çš„é–‹å•Ÿæ–¹å‘å’Œçª—æˆ¶ä½ç½®
â€¢ æ¯”ä¾‹å°ºå’ŒæŒ‡åŒ—é‡
â€¢ ä½¿ç”¨ç¹é«”ä¸­æ–‡æ¸…æ¥šæ¨™è¨»ï¼š${roomsDesc}
â€¢ å°ˆæ¥­å»ºç¯‰è£½åœ–é¢¨æ ¼
â€¢ ç™½è‰²èƒŒæ™¯ï¼Œç´°é»‘ç·šæ¢
â€¢ ä¸åŒå€åŸŸç”¨æ·¡è‰²å€åˆ†

è«‹åœ¨åœ–é¢ä¸Šæ¸…æ¥šå¯«å‡ºæ¯å€‹æˆ¿é–“çš„ç¹é«”ä¸­æ–‡åç¨±ã€‚`;

            try {
                const base64Image = await generateImageWithGemini(floorplanPrompt, state.uploadedFloorplan);
                state.floorplanImage = `data:image/png;base64,${base64Image}`;
                
                const img = document.getElementById('floorplan-image');
                const placeholder = document.getElementById('floorplan-placeholder');
                img.src = state.floorplanImage;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            } catch (error) {
                console.error('å¹³é¢åœ–ç”Ÿæˆå¤±æ•—:', error);
                const img = document.getElementById('floorplan-image');
                const placeholder = document.getElementById('floorplan-placeholder');
                img.src = `data:image/png;base64,${state.uploadedFloorplan}`;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
        }

        async function step3_generateRenders() {
            const designer = DESIGNER_STYLES[state.selectedStyle].designer;
            const rooms = state.layoutData.layout.rooms;
            const renderProgressEl = document.getElementById('render-progress');
            
            state.renders = [];
            let completed = 0;
            let totalViews = 0;
            
            rooms.forEach(room => {
                totalViews += room.name === 'å®¢å»³' ? 2 : 1;
            });

            for (const room of rooms) {
                const views = room.name === 'å®¢å»³' ? ['ä¸»æ²™ç™¼å€è¦–è§’', 'å¾å…¥å£çœ‹å‘å®¢å»³'] : [`${room.name}ä¸»è¦–è§’`];
                
                for (const view of views) {
                    completed++;
                    renderProgressEl.textContent = `æ­£åœ¨ç”Ÿæˆ ${room.name} - ${view} (${completed}/${totalViews})`;

                    const renderPrompt = `${designer.promptTemplate}. ROOM: ${room.name} ${view}. Size: ${room.area}. Furniture: ${room.furniture.join(' ')}. ${room.design_notes}. Photorealistic interior rendering, eye-level camera angle 24mm lens, natural daylight from windows, professional architectural photography, show spatial depth, realistic shadows reflections, warm inviting atmosphere, high resolution details`;

                    try {
                        const base64Image = await generateImageWithGemini(renderPrompt);
                        state.renders.push({
                            space: room.name,
                            view: view,
                            imageUrl: `data:image/png;base64,${base64Image}`,
                            description: room.design_notes
                        });
                        
                        displayRender({
                            space: room.name,
                            view: view,
                            imageUrl: `data:image/png;base64,${base64Image}`,
                            description: room.design_notes
                        });
                    } catch (error) {
                        console.error(`${room.name} æ¸²æŸ“å¤±æ•—:`, error);
                    }

                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }

        function displayRender(render) {
            const container = document.getElementById('renders-container');
            const item = document.createElement('div');
            item.className = 'render-item';
            item.innerHTML = `
                <img src="${render.imageUrl}" alt="${render.space} - ${render.view}" class="w-full h-64 object-cover">
                <div class="render-overlay">
                    <div>
                        <div class="font-bold">${render.space}</div>
                        <div class="text-sm">${render.view}</div>
                    </div>
                    <button onclick="downloadImage('${render.imageUrl}', '${render.space}-${render.view}')" class="text-white hover:text-blue-300">
                        ğŸ’¾
                    </button>
                </div>
            `;
            container.appendChild(item);
        }

        function downloadImage(dataUrl, filename) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = `${filename}-${Date.now()}.png`;
            a.click();
        }

        function downloadAllImages() {
            // ä¸‹è¼‰å¹³é¢åœ–
            if (state.floorplanImage) {
                downloadImage(state.floorplanImage, 'å¹³é¢é…ç½®åœ–');
            }

            // ä¸‹è¼‰æ‰€æœ‰æ¸²æŸ“åœ–
            state.renders.forEach((render, index) => {
                setTimeout(() => {
                    downloadImage(render.imageUrl, `${render.space}-${render.view}`);
                }, index * 500);
            });
        }

        // å•Ÿå‹•
        init();
    </script>

</body>
</html>
